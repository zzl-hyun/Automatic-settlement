<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ìë™ ì •ì‚° ê°€ê³„ë¶€</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 10px;
            background: #f8fafc;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
        }
        table { 
            width: 100%; 
            border-collapse: collapse;
            font-size: 13px;
        }
        th { 
            background: #f1f5f9;
            padding: 8px 6px;
            font-weight: 600;
            border: 1px solid #e2e8f0;
            text-align: center;
            position: sticky;
            top: 0;
        }
        td { 
            padding: 6px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        .date-col { width: 80px; font-weight: 600; }
        .place-col { width: 120px; }
        .detail-col { width: 100px; }
        .amount-col { width: 80px; font-family: monospace; }
        .payer-col { width: 70px; }
        .people-col { width: 150px; }
        .split-col { width: 70px; font-family: monospace; }
        
        /* ë¶„ë‹´ê¸ˆ ì…€ ë‚´ë¶€ ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .split-payment {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            font-size: 11px;
        }
        .split-payment input[type="checkbox"] {
            transform: scale(0.8);
            margin: 0;
        }
        .split-payment .amount {
            font-size: 10px;
            line-height: 1;
        }
        .payment-completed {
            background-color: #d1fae5 !important;
            color: #065f46 !important;
        }
        
        /* ì¸ì› ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 2px;
            font-size: 11px;
        }
        
        /* ê²°ê³¼ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .hyoseon { background-color: #EBF3FF; color: #1E40AF; }
        .gihyeon { background-color: #E0F7F0; color: #047857; }
        .younghui { background-color: #FFF4E6; color: #C2410C; }
        .sakang { background-color: #F3E8FF; color: #7C3AED; }
        
        .settlement-text {
            font-size: 10px;
            line-height: 1.2;
        }
        
        .total-amount { background: #fee2e2; font-weight: bold; }
        .equal-split { background: #dcfce7; }
        
        /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        input[type="text"], input[type="number"] {
            width: 100%;
            border: none;
            padding: 4px;
            text-align: center;
            background: transparent;
        }
        input[type="checkbox"] {
            transform: scale(0.9);
        }
        select {
            width: 100%;
            border: none;
            padding: 4px;
            background: transparent;
        }
        
        .summary {
            background: #f8fafc;
            padding: 15px;
            border-top: 2px solid #e5e7eb;
        }
        .summary h3 {
            margin: 0 0 10px 0;
            color: #374151;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .summary-card {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .total-card { border-left-color: #6366f1; }
        .hyoseon-card { border-left-color: #3b82f6; }
        .gihyeon-card { border-left-color: #10b981; }
        .younghui-card { border-left-color: #f59e0b; }
        .sakang-card { border-left-color: #8b5cf6; }
        
        /* ì¸ì› íƒœê·¸ ìŠ¤íƒ€ì¼ */
        .member-tag {
            background: rgba(255,255,255,0.25);
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 13px;
            display: flex;
            align-items: center;
            color: white;
        }
    </style>
</head>
<body>
    <!-- âš ï¸ ì €ì¥ ì•ˆë‚´ë¬¸êµ¬ ì‹œì‘ -->
    <div style="background: #fef3c7; color: #92400e; padding: 12px 0; text-align: center; font-size: 15px; font-weight: 500; border-bottom: 1px solid #fde68a; letter-spacing: -0.5px;">
        âš ï¸ <b>ì…ë ¥í•œ ë°ì´í„°ëŠ” <u>ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥</u>ë©ë‹ˆë‹¤.</b> <span style="font-weight:400;">(ìºì‹œ/ì¿ í‚¤ ì‚­ì œ, ë‹¤ë¥¸ ë¸Œë¼ìš°ì €/ê¸°ê¸°ì—ì„œëŠ” ë°ì´í„°ê°€ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. <b>ì •ê¸°ì ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°(ë°±ì—…)</b>ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤!)</span>
    </div>
    <!-- âš ï¸ ì €ì¥ ì•ˆë‚´ë¬¸êµ¬ ë -->
    <div class="container">
        <div class="header">
            <h1>ğŸ’° ìë™ ì •ì‚° ê°€ê³„ë¶€</h1>
            <p style="margin: 5px 0 0 0; opacity: 0.9;">ì¸ì› ì²´í¬í•˜ë©´ ìë™ìœ¼ë¡œ ê¸ˆì•¡ ë¶„í• !</p>
            
            <!-- ì¸ì› ê´€ë¦¬ ì„¹ì…˜ -->
            <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.15); border-radius: 8px;">
                <h3 style="margin: 0 0 10px 0; font-size: 16px;">ğŸ‘¥ ì¸ì› ê´€ë¦¬</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center;">
                    <div id="membersList" style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <!-- ê¸°ë³¸ ì¸ì›ë“¤ -->
                        <div class="member-tag" data-member="íš¨ì„ ">
                            íš¨ì„  <button onclick="removeMember('íš¨ì„ ')" style="margin-left: 5px; background: none; border: none; color: white; cursor: pointer;">Ã—</button>
                        </div>
                        <div class="member-tag" data-member="ê¸°í˜„">
                            ê¸°í˜„ <button onclick="removeMember('ê¸°í˜„')" style="margin-left: 5px; background: none; border: none; color: white; cursor: pointer;">Ã—</button>
                        </div>
                        <div class="member-tag" data-member="ì˜íœ˜">
                            ì˜íœ˜ <button onclick="removeMember('ì˜íœ˜')" style="margin-left: 5px; background: none; border: none; color: white; cursor: pointer;">Ã—</button>
                        </div>
                        <div class="member-tag" data-member="ì‚¬ê°•">
                            ì‚¬ê°• <button onclick="removeMember('ì‚¬ê°•')" style="margin-left: 5px; background: none; border: none; color: white; cursor: pointer;">Ã—</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <input type="text" id="newMemberInput" placeholder="ì¸ì›ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”" style="padding: 5px 8px; border: none; border-radius: 4px; font-size: 14px; width: 120px; background-color:white">
                        <button onclick="addMember()" style="background: #10b981; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 14px;">+ ì¶”ê°€</button>
                    </div>
                </div>
                
                <!-- ë°ì´í„° ê´€ë¦¬ ì„¹ì…˜ -->
                <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: center; font-size: 13px;">
                        <button onclick="saveData()" style="background: #3b82f6; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">ğŸ’¾ ì €ì¥</button>
                        <button onclick="loadData()" style="background: #8b5cf6; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button onclick="exportData()" style="background: #059669; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
                        <button onclick="importData()" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
                        <button onclick="clearData()" style="background: #6b7280; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
                        <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">
                    </div>
                </div>
            </div>
        </div>
        
        <table id="expenseTable">
            <thead>
                <tr>
                    <th class="date-col">ë‚ ì§œ</th>
                    <th class="place-col">ì¥ì†Œ</th>
                    <th class="detail-col">ìƒì„¸ë‚´ì—­</th>
                    <th class="amount-col">ì´ ê²°ì œì•¡</th>
                    <th class="payer-col">ê²°ì œì</th>
                    <th class="people-col">ì°¸ì—¬ ì¸ì›</th>
                </tr>
                <tr id="memberColumns">
                    <th colspan="6"></th>
                    <th class="split-col">íš¨ì„ </th>
                    <th class="split-col">ê¸°í˜„</th>
                    <th class="split-col">ì˜íœ˜</th>
                    <th class="split-col">ì‚¬ê°•</th>
                </tr>
            </thead>
            <tbody>
                <!-- í•­ëª©(ì§€ì¶œ í–‰)ë“¤ì€ JSë¡œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                
                <!-- ìƒˆ í–‰ ì¶”ê°€ ë²„íŠ¼ìš© ë¹ˆ í–‰ -->
                <tr>
                    <td colspan="10" style="text-align: center; padding: 15px; background: #f9fafb;">
                        <button onclick="addNewRow()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">+ ìƒˆ í•­ëª© ì¶”ê°€</button>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <div class="summary">
            <h3>ğŸ“Š ì›”ë§ ì •ì‚° ìš”ì•½</h3>
            <div class="summary-grid">
                <div class="summary-card total-card">
                    <div style="font-size: 18px; font-weight: bold;" id="totalAmount">$53.85</div>
                    <div style="color: #6b7280; font-size: 14px;">ì´ ì§€ì¶œ</div>
                </div>
                <div class="summary-card hyoseon-card">
                    <div style="font-size: 16px; font-weight: bold; color: #1E40AF;" id="hyoseonTotal">$33.65</div>
                    <div style="color: #6b7280; font-size: 14px;">íš¨ì„  ë¶„ë‹´</div>
                </div>
                <div class="summary-card gihyeon-card">
                    <div style="font-size: 16px; font-weight: bold; color: #047857;" id="gihyeonTotal">$20.21</div>
                    <div style="color: #6b7280; font-size: 14px;">ê¸°í˜„ ë¶„ë‹´</div>
                </div>
                <div class="summary-card younghui-card">
                    <div style="font-size: 16px; font-weight: bold; color: #C2410C;" id="younghuiTotal">$0.00</div>
                    <div style="color: #6b7280; font-size: 14px;">ì˜íœ˜ ë¶„ë‹´</div>
                </div>
                <div class="summary-card sakang-card">
                    <div style="font-size: 16px; font-weight: bold; color: #7C3AED;" id="sakangTotal">$0.00</div>
                    <div style="color: #6b7280; font-size: 14px;">ì‚¬ê°• ë¶„ë‹´</div>
                </div>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                <strong>ğŸ’¸ ì •ì‚° ê²°ê³¼:</strong>
                <div id="finalSettlement" style="margin-top: 0; font-family: monospace; flex:1;">
                    ê¸°í˜„ì´ íš¨ì„ ì—ê²Œ $20.21 ì¤˜ì•¼ í•¨
                </div>
                <button id="clearSettlementBtn" style="background: #f87171; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;">ì •ì‚°ë‚´ì—­ ì§€ìš°ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // ì •ì‚°ë‚´ì—­(ê²°ê³¼) ì§€ìš°ê¸° ë²„íŠ¼ ê¸°ëŠ¥
        document.addEventListener('DOMContentLoaded', function() {
            const clearBtn = document.getElementById('clearSettlementBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    document.getElementById('finalSettlement').innerHTML = '';
                });
            }
        });

        // ì§€ì¶œ í–‰ ì‚­ì œ í•¨ìˆ˜ (ì „ì—­ ë“±ë¡)
        window.removeExpenseRow = function(btn) {
            const row = btn.closest('tr');
            if (row) {
                row.remove();
                updateSummary();
                saveData(true);
            }
        }
        // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ ë©¤ë²„ ëª©ë¡ ê´€ë¦¬
        let currentMembers = ['íš¨ì„ ', 'ê¸°í˜„', 'ì˜íœ˜', 'ì‚¬ê°•'];
        
        // ë©¤ë²„ ì¶”ê°€ í•¨ìˆ˜
        function addMember() {
            const input = document.getElementById('newMemberInput');
            const newMember = input.value.trim();
            
            if (!newMember) {
                alert('ì¸ì› ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (currentMembers.includes(newMember)) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¸ì›ì…ë‹ˆë‹¤.');
                return;
            }
            
            currentMembers.push(newMember);
            input.value = '';
            updateMemberUI();
            updateTableStructure();
        }
        
        // ë©¤ë²„ ì œê±° í•¨ìˆ˜
        function removeMember(memberName) {
            if (currentMembers.length <= 1) {
                alert('ìµœì†Œ 1ëª…ì˜ ì¸ì›ì€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            currentMembers = currentMembers.filter(member => member !== memberName);
            updateMemberUI();
            updateTableStructure();
        }
        
        // ë©¤ë²„ UI ì—…ë°ì´íŠ¸
        function updateMemberUI() {
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';
            
            currentMembers.forEach(member => {
                const memberTag = document.createElement('div');
                memberTag.className = 'member-tag';
                memberTag.setAttribute('data-member', member);
                memberTag.innerHTML = `
                    ${member} 
                    <button onclick="removeMember('${member}')" style="margin-left: 5px; background: none; border: none; color: white; cursor: pointer;">Ã—</button>
                `;
                membersList.appendChild(memberTag);
            });
        }
        
        // í…Œì´ë¸” êµ¬ì¡° ì—…ë°ì´íŠ¸
        function updateTableStructure() {
            // í—¤ë” í–‰ ì—…ë°ì´íŠ¸
            const memberColumns = document.getElementById('memberColumns');
            memberColumns.innerHTML = '<th colspan="6"></th>';
            
            currentMembers.forEach(member => {
                const th = document.createElement('th');
                th.className = 'split-col';
                th.textContent = member;
                memberColumns.appendChild(th);
            });
            
            // ëª¨ë“  ë°ì´í„° í–‰ ì—…ë°ì´íŠ¸
            const rows = document.querySelectorAll('#expenseTable tbody tr');
            rows.forEach((row, rowIndex) => {
                if (rowIndex >= rows.length - 1) return; // ë§ˆì§€ë§‰ ë²„íŠ¼ í–‰ ì œì™¸
                
                updateRowStructure(row, rowIndex + 1);
            });
            
            // ìš”ì•½ ì„¹ì…˜ ì—…ë°ì´íŠ¸
            updateSummaryStructure();
            
            // ë²„íŠ¼ í–‰ colspan ë™ì  ì¡°ì •
            const buttonRow = document.querySelector('#expenseTable tbody tr:last-child td');
            if (buttonRow) {
                buttonRow.colSpan = 6 + currentMembers.length;
            }
        }
        
        // ê°œë³„ í–‰ êµ¬ì¡° ì—…ë°ì´íŠ¸
        function updateRowStructure(row, rowIndex) {
            // ê¸°ì¡´ ë¶„ë‹´ê¸ˆ ì…€ë“¤ ì œê±°
            const cellsToRemove = row.querySelectorAll('.split-col');
            cellsToRemove.forEach(cell => cell.remove());
            
            // ì°¸ì—¬ ì¸ì› ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
            const peopleCell = row.querySelector('.people-col .checkbox-group');
            if (peopleCell) {
                // ê¸°ì¡´ ì²´í¬ëœ ìƒíƒœ ì €ì¥
                const existingChecked = [];
                const existingCheckboxes = peopleCell.querySelectorAll('input[type="checkbox"]');
                existingCheckboxes.forEach((checkbox, index) => {
                    if (checkbox.checked) {
                        const labelText = checkbox.nextElementSibling?.textContent;
                        if (labelText) {
                            existingChecked.push(labelText);
                        }
                    }
                });
                
                peopleCell.innerHTML = '';
                     currentMembers.forEach((member, index) => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                const isChecked = existingChecked.includes(member) ? 'checked' : '';
                checkboxItem.innerHTML = `
                    <input type="checkbox" id="${member.toLowerCase().replace(/[^a-z0-9]/g, '_')}_${rowIndex}" ${isChecked} onchange="calculateSplit(this)">
                    <label for="${member.toLowerCase().replace(/[^a-z0-9]/g, '_')}_${rowIndex}">${member}</label>
                `;
                peopleCell.appendChild(checkboxItem);
            });
            }
            
            // ê²°ì œì ì…€ë ‰íŠ¸ ì˜µì…˜ ì—…ë°ì´íŠ¸
            const payerSelect = row.querySelector('.payer-col select');
            if (payerSelect) {
                const selectedValue = payerSelect.value;
                payerSelect.innerHTML = '';
                
                currentMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    if (member === selectedValue) option.selected = true;
                    payerSelect.appendChild(option);
                });
                
                // ì„ íƒëœ ê°’ì´ ì‚­ì œëœ ë©¤ë²„ì˜€ë‹¤ë©´ ì²« ë²ˆì§¸ ë©¤ë²„ë¡œ ì„¤ì •
                if (!currentMembers.includes(selectedValue)) {
                    payerSelect.value = currentMembers[0];
                }
            }
            
            // ìƒˆë¡œìš´ ë¶„ë‹´ê¸ˆ ì…€ë“¤ ì¶”ê°€
            currentMembers.forEach(member => {
                const splitCell = document.createElement('td');
                splitCell.className = `split-col ${member.toLowerCase()}`;
                splitCell.id = `${member.toLowerCase()}${rowIndex}`;
                splitCell.textContent = '-';
                row.appendChild(splitCell);
            });
            
            // ë¶„í•  ê³„ì‚° ì‹¤í–‰
            setTimeout(() => {
                const amountInput = row.querySelector('input[type="number"]');
                if (amountInput && amountInput.value) {
                    calculateSplit(amountInput);
                }
            }, 10);
        }
        
        // ìš”ì•½ ì„¹ì…˜ êµ¬ì¡° ì—…ë°ì´íŠ¸
        function updateSummaryStructure() {
            const summaryGrid = document.querySelector('.summary-grid');
            summaryGrid.innerHTML = `
                <div class="summary-card total-card">
                    <div style="font-size: 18px; font-weight: bold;" id="totalAmount">$0.00</div>
                    <div style="color: #6b7280; font-size: 14px;">ì´ ì§€ì¶œ</div>
                </div>
            `;
            
            // ê° ë©¤ë²„ë³„ ì¹´ë“œ ì¶”ê°€
            currentMembers.forEach((member, index) => {
                const colors = ['#1E40AF', '#047857', '#C2410C', '#7C3AED', '#DC2626', '#059669', '#D97706', '#7C3AED'];
                const cardDiv = document.createElement('div');
                cardDiv.className = `summary-card ${member.toLowerCase()}-card`;
                cardDiv.innerHTML = `
                    <div style="font-size: 16px; font-weight: bold; color: ${colors[index % colors.length]};" id="${member.toLowerCase()}Total">$0.00</div>
                    <div style="color: #6b7280; font-size: 14px;">${member} ë¶„ë‹´</div>
                `;
                summaryGrid.appendChild(cardDiv);
            });
            
            updateSummary();
        }

        function calculateSplit(element) {
            const row = element.closest('tr');
            const rowIndex = Array.from(row.parentNode.children).indexOf(row) + 1;
            
            const totalAmount = parseFloat(row.querySelector('input[type="number"]').value) || 0;
            const checkboxes = row.querySelectorAll('input[type="checkbox"]');
            
            let participantCount = 0;
            let participants = [];
            
            checkboxes.forEach((checkbox, index) => {
                if (checkbox.checked && currentMembers[index]) {
                    participantCount++;
                    participants.push(currentMembers[index]);
                }
            });
            
            const splitAmount = participantCount > 0 ? (totalAmount / participantCount) : 0;
            
            // ë””ë²„ê¹…: ë¶„í•  ê³„ì‚° ê³¼ì • ì¶œë ¥
            console.log(`í–‰ ${rowIndex}: ì´ì•¡=$${totalAmount}, ì°¸ê°€ì=${participants.join(',')}, 1ì¸ë‹¹=$${splitAmount.toFixed(2)}`);
            
            // ê°œë³„ ë¶„ë‹´ê¸ˆ ì—…ë°ì´íŠ¸
            currentMembers.forEach((member, index) => {
                const cell = document.getElementById(member.toLowerCase() + rowIndex);
                if (cell) {
                    if (checkboxes[index] && checkboxes[index].checked && participantCount > 0) {
                        // ê¸°ì¡´ ì²´í¬ë°•ìŠ¤ ìƒíƒœ í™•ì¸
                        const checkboxId = `payment_${member.toLowerCase()}_${rowIndex}`;
                        const existingCheckbox = document.getElementById(checkboxId);
                        const wasChecked = existingCheckbox ? existingCheckbox.checked : false;
                        
                        // ì²´í¬ë°•ìŠ¤ì™€ ê¸ˆì•¡ì„ í•¨ê»˜ í‘œì‹œ
                        cell.innerHTML = `
                            <div class="split-payment">
                                <input type="checkbox" id="${checkboxId}" onchange="togglePaymentStatus(this)" title="ì†¡ê¸ˆ ì™„ë£Œ ì²´í¬" ${wasChecked ? 'checked' : ''}>
                                <div class="amount">$${splitAmount.toFixed(2)}</div>
                            </div>
                        `;
                        cell.classList.add('equal-split');
                        
                        // ì²´í¬ëœ ìƒíƒœì˜€ë‹¤ë©´ payment-completed í´ë˜ìŠ¤ë„ ì¶”ê°€
                        if (wasChecked) {
                            cell.classList.add('payment-completed');
                        }
                        
                        console.log(`  ${member}: $${splitAmount.toFixed(2)} (ì°¸ì—¬)`);
                    } else {
                        cell.innerHTML = '-';
                        cell.classList.remove('equal-split', 'payment-completed');
                        console.log(`  ${member}: - (ë¯¸ì°¸ì—¬)`);
                    }
                }
            });
            
            updateSummary();
        }
        
        function updateSummary() {
            const rows = document.querySelectorAll('#expenseTable tbody tr');
            let totals = {total: 0};
            
            // ê° ë©¤ë²„ë³„ í•©ê³„ ì´ˆê¸°í™”
            currentMembers.forEach(member => {
                totals[member.toLowerCase()] = 0;
            });
            
            // ê° í•­ëª©ë³„ ì •ì‚° ì •ë³´ ì €ì¥
            let itemSettlements = [];
            
            rows.forEach((row, index) => {
                if (index >= rows.length - 1) return; // ë§ˆì§€ë§‰ ì¶”ê°€ ë²„íŠ¼ í–‰ ì œì™¸
                
                const totalInput = row.querySelector('input[type="number"]');
                const payerSelect = row.querySelector('.payer-col select');
                const checkboxes = row.querySelectorAll('input[type="checkbox"]');
                
                if (!totalInput || !payerSelect) return;
                
                const amount = parseFloat(totalInput.value) || 0;
                const payer = payerSelect.value;
                
                if (amount > 0) {
                    totals.total += amount;
                    
                    // ì´ í•­ëª©ì˜ ì°¸ì—¬ìë“¤ ì°¾ê¸°
                    let participants = [];
                    checkboxes.forEach((checkbox, i) => {
                        if (checkbox.checked && currentMembers[i]) {
                            participants.push(currentMembers[i]);
                        }
                    });
                    
                    if (participants.length > 0) {
                        const splitAmount = amount / participants.length;
                        
                        // ê° ì°¸ì—¬ìì˜ ë¶„ë‹´ê¸ˆ í•©ê³„ì— ì¶”ê°€
                        participants.forEach(participant => {
                            totals[participant.toLowerCase()] += splitAmount;
                        });
                        
                        // ì´ í•­ëª©ì˜ ì •ì‚° ì •ë³´ ì €ì¥
                        itemSettlements.push({
                            amount: amount,
                            payer: payer,
                            participants: participants,
                            splitAmount: splitAmount
                        });
                    }
                }
            });
            
            // ìš”ì•½ ì—…ë°ì´íŠ¸
            document.getElementById('totalAmount').textContent = '$' + totals.total.toFixed(2);
            
            currentMembers.forEach(member => {
                const totalElement = document.getElementById(member.toLowerCase() + 'Total');
                if (totalElement) {
                    totalElement.textContent = '$' + totals[member.toLowerCase()].toFixed(2);
                }
            });
            
            // ê° í•­ëª©ë³„ë¡œ ë…ë¦½ì ì¸ ì •ì‚° ê³„ì‚°
            let allResults = [];
            const threshold = 0.01;
            
            itemSettlements.forEach((item, itemIndex) => {
                console.log(`=== í•­ëª© ${itemIndex + 1} ì •ì‚° ===`);
                console.log(`ê¸ˆì•¡: $${item.amount}, ê²°ì œì: ${item.payer}, ì°¸ì—¬ì: ${item.participants.join(', ')}, 1ì¸ë‹¹: $${item.splitAmount.toFixed(2)}`);
                
                // ì´ í•­ëª©ì—ì„œì˜ ê° ì°¸ì—¬ìë³„ ì •ì‚°ì•¡ ê³„ì‚°
                let itemSettlement = {};
                item.participants.forEach(participant => {
                    if (participant === item.payer) {
                        // ê²°ì œì: ì‹¤ì œ ë‚¸ ê¸ˆì•¡ - ë¶„ë‹´ê¸ˆ
                        itemSettlement[participant] = item.amount - item.splitAmount;
                    } else {
                        // ë‹¤ë¥¸ ì°¸ì—¬ì: 0 - ë¶„ë‹´ê¸ˆ (ì¤„ ê¸ˆì•¡)
                        itemSettlement[participant] = 0 - item.splitAmount;
                    }
                });
                
                console.log('í•­ëª©ë³„ ì •ì‚°ì•¡:', itemSettlement);
                
                // ì´ í•­ëª©ì—ì„œ ë°›ì„ ì‚¬ëŒê³¼ ì¤„ ì‚¬ëŒ ë¶„ë¦¬
                let receivers = [], givers = [];
                item.participants.forEach(participant => {
                    if (itemSettlement[participant] > threshold) {
                        receivers.push({member: participant, amount: itemSettlement[participant]});
                    } else if (itemSettlement[participant] < -threshold) {
                        givers.push({member: participant, amount: -itemSettlement[participant]});
                    }
                });
                
                // ì´ í•­ëª©ì—ì„œì˜ ì†¡ê¸ˆ ë‚´ì—­ ê³„ì‚°
                for (let g = 0; g < givers.length; g++) {
                    let give = givers[g];
                    for (let r = 0; r < receivers.length && give.amount > threshold; r++) {
                        let recv = receivers[r];
                        if (recv.amount > threshold) {
                            let transferAmount = Math.min(give.amount, recv.amount);
                            allResults.push(`${give.member} -> ${recv.member}ì—ê²Œ $${transferAmount.toFixed(2)}`);
                            give.amount -= transferAmount;
                            recv.amount -= transferAmount;
                        }
                    }
                }
                console.log('========================');
            });
            
            // ìƒì‡„ ê³„ì‚°: ì„œë¡œ ì£¼ê³ ë°›ì„ ê¸ˆì•¡ì´ ìˆìœ¼ë©´ ì°¨ê°
            let netTransfers = {};
            
            // ëª¨ë“  ì†¡ê¸ˆ ë‚´ì—­ì„ íŒŒì‹±í•´ì„œ net ê¸ˆì•¡ ê³„ì‚°
            allResults.forEach(result => {
                // "A -> Bì—ê²Œ $X" í˜•íƒœ íŒŒì‹±
                const match = result.match(/(.+) -> (.+)ì—ê²Œ \$([0-9.]+)/);
                if (match) {
                    const [, giver, receiver, amount] = match;
                    const transferAmount = parseFloat(amount);
                    
                    // A -> B ë°©í–¥ìœ¼ë¡œ net ê¸ˆì•¡ ê³„ì‚°
                    const key1 = `${giver}->${receiver}`;
                    const key2 = `${receiver}->${giver}`;
                    
                    if (netTransfers[key1]) {
                        netTransfers[key1] += transferAmount;
                    } else if (netTransfers[key2]) {
                        netTransfers[key2] -= transferAmount;
                    } else {
                        netTransfers[key1] = transferAmount;
                    }
                }
            });
            
            // ìµœì¢… ìƒì‡„ëœ ê²°ê³¼ ìƒì„±
            let finalResults = [];
            Object.keys(netTransfers).forEach(key => {
                const amount = netTransfers[key];
                if (Math.abs(amount) > threshold) {
                    const [giver, receiver] = key.split('->');
                    if (amount > 0) {
                        finalResults.push(`${giver} -> ${receiver}ì—ê²Œ $${amount.toFixed(2)}`);
                    } else {
                        finalResults.push(`${receiver} -> ${giver}ì—ê²Œ $${Math.abs(amount).toFixed(2)}`);
                    }
                }
            });
            
            console.log('=== ìƒì‡„ ì „ ì†¡ê¸ˆ ë‚´ì—­ ===');
            console.log(allResults);
            console.log('=== ìƒì‡„ í›„ ìµœì¢… ì†¡ê¸ˆ ë‚´ì—­ ===');
            console.log(finalResults);
            
            // ìµœì¢… ì •ì‚° ê²°ê³¼ í‘œì‹œ
            let finalText = finalResults.length > 0 ? finalResults.join('<br>') : 'ì •ì‚° ì™„ë£Œ';
            document.getElementById('finalSettlement').innerHTML = finalText;
        }
        
        function addNewRow() {
            const tbody = document.querySelector('#expenseTable tbody');
            const newRowIndex = tbody.children.length; // ë§ˆì§€ë§‰ ë²„íŠ¼ í–‰ í¬í•¨í•´ì„œ ê³„ì‚°
            
            const newRow = document.createElement('tr');
            
            // ê¸°ë³¸ ì…€ë“¤ ìƒì„±
            let rowHTML = `
                <td class="date-col">
                    <input type="text" placeholder="MM/DD">
                </td>
                <td class="place-col">
                    <input type="text" placeholder="ì¥ì†Œ">
                </td>
                <td class="detail-col">
                    <input type="text" placeholder="ë‚´ì—­">
                </td>
                <td class="amount-col total-amount">
                    <input type="number" step="0.01" onchange="calculateSplit(this)">
                </td>
                <td class="payer-col">
                    <select>
            `;
            
            currentMembers.forEach(member => {
                rowHTML += `<option value="${member}">${member}</option>`;
            });
            
            rowHTML += `
                    </select>
                </td>
                <td class="people-col">
                    <div class="checkbox-group">
            `;
            
            currentMembers.forEach((member, index) => {
                rowHTML += `
                        <div class="checkbox-item">
                            <input type="checkbox" id="${member.toLowerCase().replace(/[^a-z0-9]/g, '_')}_${newRowIndex}" onchange="calculateSplit(this)">
                            <label for="${member.toLowerCase().replace(/[^a-z0-9]/g, '_')}_${newRowIndex}">${member}</label>
                        </div>
                `;
            });
            
            rowHTML += `
                    </div>
                </td>
            `;
            
            // ê° ë©¤ë²„ë³„ ë¶„ë‹´ê¸ˆ ì…€ ì¶”ê°€
            currentMembers.forEach(member => {
                rowHTML += `<td class="split-col ${member.toLowerCase()}" id="${member.toLowerCase()}${newRowIndex}">-</td>`;
            });
            // ì‚­ì œ ë²„íŠ¼ ì…€ ì¶”ê°€ (width ìµœì†Œí™”)
            rowHTML += `<td style="width:36px;"><button onclick="removeExpenseRow(this)" style="background:#f87171;color:white;border:none;padding:2px 6px;border-radius:4px;cursor:pointer;font-size:15px;width:26px;min-width:0;">ğŸ—‘ï¸</button></td>`;

            newRow.innerHTML = rowHTML;
            // ë§ˆì§€ë§‰ ë²„íŠ¼ í–‰ ì•ì— ì‚½ì…
            tbody.insertBefore(newRow, tbody.lastElementChild);
        }
        
        // Enter í‚¤ë¡œ ë©¤ë²„ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', function() {
            loadData(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            
            // ê¸°ì¡´ í–‰ë“¤ì— ëŒ€í•´ ê³„ì‚° ì‹¤í–‰
            setTimeout(() => {
                const existingRows = document.querySelectorAll('#expenseTable tbody tr:not(:last-child)');
                existingRows.forEach(row => {
                    const amountInput = row.querySelector('input[type="number"]');
                    if (amountInput && amountInput.value) {
                        calculateSplit(amountInput);
                    }
                });
            }, 100);
            
            document.getElementById('newMemberInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addMember();
                }
            });
            
            // ë°ì´í„° ë³€ê²½ ì‹œ ìë™ ì €ì¥ (3ì´ˆ í›„)
            let autoSaveTimeout;
            function scheduleAutoSave() {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(() => {
                    saveData(true); // true = ìë™ì €ì¥ ëª¨ë“œ
                }, 3000);
            }
            
            // ì…ë ¥ í•„ë“œ ë³€ê²½ ê°ì§€
            document.addEventListener('input', scheduleAutoSave);
            document.addEventListener('change', scheduleAutoSave);
        });
        
        // ë°ì´í„° ì €ì¥ í•¨ìˆ˜
        function saveData(isAutoSave = false) {
            try {
                const data = {
                    members: [...currentMembers], // ë°°ì—´ ë³µì‚¬
                    expenses: [],
                    lastSaved: new Date().toISOString(),
                    version: "1.0" // ë²„ì „ ì •ë³´ ì¶”ê°€
                };
                
                // ëª¨ë“  í–‰ì˜ ë°ì´í„° ìˆ˜ì§‘
                const rows = document.querySelectorAll('#expenseTable tbody tr');
                rows.forEach((row, index) => {
                    if (index >= rows.length - 1) return; // ë§ˆì§€ë§‰ ë²„íŠ¼ í–‰ ì œì™¸
                    
                    const dateInput = row.querySelector('.date-col input');
                    const placeInput = row.querySelector('.place-col input');
                    const detailInput = row.querySelector('.detail-col input');
                    const amountInput = row.querySelector('.amount-col input');
                    const payerSelect = row.querySelector('.payer-col select');
                    const checkboxes = row.querySelectorAll('input[type="checkbox"]');
                    
                    // ëª¨ë“  í•„ë“œê°€ ë¹„ì–´ìˆëŠ” í–‰ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ
                    if (!dateInput?.value && !placeInput?.value && !detailInput?.value && !amountInput?.value) {
                        return;
                    }
                    
                    const participants = [];
                    const paymentStatus = {}; // ë¶„ë‹´ê¸ˆ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì €ì¥
                    
                    // ì°¸ì—¬ ì¸ì› ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬ (ì¸ì› ì°¸ì—¬ ì²´í¬ë°•ìŠ¤ë§Œ)
                    checkboxes.forEach((checkbox, i) => {
                        // payment_ ë¡œ ì‹œì‘í•˜ì§€ ì•ŠëŠ” ì²´í¬ë°•ìŠ¤ë§Œ ì¸ì› ì°¸ì—¬ìš©
                        if (!checkbox.id.startsWith('payment_') && checkbox.checked && currentMembers[i]) {
                            participants.push(currentMembers[i]);
                        }
                    });
                    
                    // ë¶„ë‹´ê¸ˆ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ìˆ˜ì§‘
                    currentMembers.forEach(member => {
                        const paymentCheckbox = row.querySelector(`input[id^="payment_${member.toLowerCase()}_"]`);
                        if (paymentCheckbox) {
                            paymentStatus[member] = paymentCheckbox.checked;
                        }
                    });
                    
                    data.expenses.push({
                        date: dateInput?.value || '',
                        place: placeInput?.value || '',
                        detail: detailInput?.value || '',
                        amount: parseFloat(amountInput?.value) || 0,
                        payer: payerSelect?.value || currentMembers[0],
                        participants: participants,
                        paymentStatus: paymentStatus
                    });
                });
                
                localStorage.setItem('expenseData', JSON.stringify(data));
                
                if (!isAutoSave) {
                    alert(`ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n- ì¸ì›: ${data.members.length}ëª…\n- ì§€ì¶œ í•­ëª©: ${data.expenses.length}ê°œ`);
                }
                
                return true; // ì €ì¥ ì„±ê³µ
            } catch (error) {
                console.error('ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
                if (!isAutoSave) {
                    alert('ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
                return false; // ì €ì¥ ì‹¤íŒ¨
            }
        }
        
        // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
        function loadData() {
            try {
                const savedData = localStorage.getItem('expenseData');
                if (!savedData) {
                    console.log('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìƒíƒœë¡œ ì‹œì‘í•©ë‹ˆë‹¤.');
                    updateSummary(); // ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ìš”ì•½ë§Œ ì—…ë°ì´íŠ¸
                    return;
                }
                
                const data = JSON.parse(savedData);
                
                // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
                if (!data.members || !Array.isArray(data.members)) {
                    console.error('ì €ì¥ëœ ë°ì´í„°ê°€ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ë©¤ë²„ ëª©ë¡ ë³µì›
                if (data.members.length > 0) {
                    currentMembers = [...data.members]; // ë°°ì—´ ë³µì‚¬
                    updateMemberUI();
                    updateTableStructure();
                }
                
                // ê¸°ì¡´ ë°ì´í„° í–‰ë“¤ ì œê±° (ë²„íŠ¼ í–‰ ì œì™¸)
                const tbody = document.querySelector('#expenseTable tbody');
                const existingRows = tbody.querySelectorAll('tr:not(:last-child)');
                existingRows.forEach(row => row.remove());
                
                // ì €ì¥ëœ ì§€ì¶œ ë‚´ì—­ ë³µì›
                if (data.expenses && Array.isArray(data.expenses) && data.expenses.length > 0) {
                    data.expenses.forEach((expense, index) => {
                        try {
                            const newRow = createExpenseRow(index + 1, expense);
                            tbody.insertBefore(newRow, tbody.lastElementChild);
                        } catch (error) {
                            console.error(`ì§€ì¶œ í•­ëª© ${index + 1} ë¡œë“œ ì¤‘ ì˜¤ë¥˜:`, error);
                        }
                    });
                }
                
                updateSummary();
                
                if (data.lastSaved) {
                    const lastSaved = new Date(data.lastSaved);
                    console.log('ë§ˆì§€ë§‰ ì €ì¥:', lastSaved.toLocaleString('ko-KR'));
                }
                
                console.log(`ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ì¸ì› ${data.members.length}ëª…, ì§€ì¶œ í•­ëª© ${data.expenses?.length || 0}ê°œ`);
                
            } catch (error) {
                console.error('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ìƒíƒœë¡œ ì‹œì‘í•©ë‹ˆë‹¤.');
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ localStorage ì •ë¦¬
                localStorage.removeItem('expenseData');
            }
        }
        
        // ì§€ì¶œ í–‰ ìƒì„± í•¨ìˆ˜
        function createExpenseRow(rowIndex, expense) {
            const newRow = document.createElement('tr');
            
            let rowHTML = `
                <td class="date-col">
                    <input type="text" value="${expense.date || ''}" placeholder="MM/DD">
                </td>
                <td class="place-col">
                    <input type="text" value="${expense.place || ''}" placeholder="ì¥ì†Œ">
                </td>
                <td class="detail-col">
                    <input type="text" value="${expense.detail || ''}" placeholder="ë‚´ì—­">
                </td>
                <td class="amount-col total-amount">
                    <input type="number" value="${expense.amount || ''}" step="0.01" onchange="calculateSplit(this)">
                </td>
                <td class="payer-col">
                    <select>
            `;
            
            currentMembers.forEach(member => {
                const selected = member === expense.payer ? 'selected' : '';
                rowHTML += `<option value="${member}" ${selected}>${member}</option>`;
            });
            
            rowHTML += `
                    </select>
                </td>
                <td class="people-col">
                    <div class="checkbox-group">
            `;
            
            currentMembers.forEach((member, index) => {
                const checked = expense.participants && expense.participants.includes(member) ? 'checked' : '';
                rowHTML += `
                        <div class="checkbox-item">
                            <input type="checkbox" id="${member.toLowerCase().replace(/[^a-z0-9]/g, '_')}_${rowIndex}" ${checked} onchange="calculateSplit(this)">
                            <label for="${member.toLowerCase().replace(/[^a-z0-9]/g, '_')}_${rowIndex}">${member}</label>
                        </div>
                `;
            });
            
            rowHTML += `
                    </div>
                </td>
            `;
            
            // ê° ë©¤ë²„ë³„ ë¶„ë‹´ê¸ˆ ì…€ ì¶”ê°€
            currentMembers.forEach(member => {
                rowHTML += `<td class="split-col ${member.toLowerCase()}" id="${member.toLowerCase()}${rowIndex}">-</td>`;
            });
            // ì‚­ì œ ë²„íŠ¼ ì…€ ì¶”ê°€ (width ìµœì†Œí™”)
            rowHTML += `<td style="width:36px;"><button onclick="removeExpenseRow(this)" style="background:#f87171;color:white;border:none;padding:2px 6px;border-radius:4px;cursor:pointer;font-size:15px;width:26px;min-width:0;">ğŸ—‘ï¸</button></td>`;

            newRow.innerHTML = rowHTML;
            
            // ë¶„í•  ê³„ì‚° ì‹¤í–‰
            setTimeout(() => {
                const amountInput = newRow.querySelector('input[type="number"]');
                if (amountInput) {
                    calculateSplit(amountInput);
                    
                    // ì €ì¥ëœ ë¶„ë‹´ê¸ˆ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì›
                    if (expense.paymentStatus) {
                        currentMembers.forEach(member => {
                            if (expense.paymentStatus[member]) {
                                const paymentCheckbox = newRow.querySelector(`input[id^="payment_${member.toLowerCase()}_"]`);
                                if (paymentCheckbox) {
                                    paymentCheckbox.checked = true;
                                    const cell = paymentCheckbox.closest('td');
                                    if (cell) {
                                        cell.classList.add('payment-completed');
                                    }
                                }
                            }
                        });
                    }
                }
            }, 10);
            return newRow;
        }
        
        // ë°ì´í„° ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜
        function exportData() {
            try {
                // í˜„ì¬ í™”ë©´ì˜ ë°ì´í„°ë¥¼ ë¨¼ì € ì €ì¥
                saveData(true);
                
                const savedData = localStorage.getItem('expenseData');
                if (!savedData) {
                    alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const data = JSON.parse(savedData);
                
                // ë‚´ë³´ë‚´ê¸° í™•ì¸ ë©”ì‹œì§€
                const memberCount = data.members ? data.members.length : 0;
                const expenseCount = data.expenses ? data.expenses.length : 0;
                
                if (!confirm(`ë‹¤ìŒ ë°ì´í„°ë¥¼ ë‚´ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?\n- ì¸ì›: ${memberCount}ëª…\n- ì§€ì¶œ í•­ëª©: ${expenseCount}ê°œ`)) {
                    return;
                }
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `ì •ì‚°ë‚´ì—­_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('ë°ì´í„°ê°€ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸° ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜:', error);
                alert('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ë°ì´í„° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        function importData() {
            document.getElementById('fileInput').click();
        }
        
        // íŒŒì¼ ê°€ì ¸ì˜¤ê¸° ì²˜ë¦¬ í•¨ìˆ˜
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // íŒŒì¼ í˜•ì‹ í™•ì¸
            if (!file.name.endsWith('.json')) {
                alert('JSON íŒŒì¼ë§Œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
                    if (!data.members || !Array.isArray(data.members)) {
                        throw new Error('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤. (members ë°°ì—´ì´ ì—†ìŒ)');
                    }
                    
                    if (!data.expenses || !Array.isArray(data.expenses)) {
                        throw new Error('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤. (expenses ë°°ì—´ì´ ì—†ìŒ)');
                    }
                    
                    // ê°€ì ¸ì˜¤ê¸° í™•ì¸ ë©”ì‹œì§€
                    const memberCount = data.members.length;
                    const expenseCount = data.expenses.length;
                    
                    if (!confirm(`ë‹¤ìŒ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\n- ì¸ì›: ${memberCount}ëª… (${data.members.join(', ')})\n- ì§€ì¶œ í•­ëª©: ${expenseCount}ê°œ\n\nâš ï¸ í˜„ì¬ ë°ì´í„°ëŠ” ëª¨ë‘ ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤!`)) {
                        event.target.value = '';
                        return;
                    }
                    
                    // localStorageì— ì €ì¥
                    localStorage.setItem('expenseData', JSON.stringify(data));
                    
                    // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                    loadData();
                    
                    alert(`ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!\n- ì¸ì›: ${memberCount}ëª…\n- ì§€ì¶œ í•­ëª©: ${expenseCount}ê°œ`);
                } catch (error) {
                    console.error('íŒŒì¼ ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜:', error);
                    let errorMessage = 'íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    if (error.message.includes('JSON')) {
                        errorMessage = 'JSON íŒŒì¼ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    } else if (error.message.includes('members') || error.message.includes('expenses')) {
                        errorMessage = error.message;
                    }
                    alert(errorMessage);
                }
            };
            
            reader.onerror = function() {
                alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            };
            
            reader.readAsText(file);
            
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            event.target.value = '';
        }
        
        // ë°ì´í„° ì´ˆê¸°í™” í•¨ìˆ˜
        function clearData() {
            if (!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            try {
                localStorage.removeItem('expenseData');
                
                // ê¸°ë³¸ ë©¤ë²„ë¡œ ì´ˆê¸°í™”
                currentMembers = ['íš¨ì„ ', 'ê¸°í˜„', 'ì˜íœ˜', 'ì‚¬ê°•'];
                updateMemberUI();
                updateTableStructure();
                
                // ëª¨ë“  ë°ì´í„° í–‰ ì œê±°
                const tbody = document.querySelector('#expenseTable tbody');
                const existingRows = tbody.querySelectorAll('tr:not(:last-child)');
                existingRows.forEach(row => row.remove());
                
                updateSummary();
                
                alert('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
                alert('ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì†¡ê¸ˆ ì™„ë£Œ ìƒíƒœ í† ê¸€ í•¨ìˆ˜
        window.togglePaymentStatus = function(checkbox) {
            const cell = checkbox.closest('td');
            if (checkbox.checked) {
                cell.classList.add('payment-completed');
            } else {
                cell.classList.remove('payment-completed');
            }
            // ìë™ ì €ì¥
            saveData(true);
        }
    </script>
</body>
</html>